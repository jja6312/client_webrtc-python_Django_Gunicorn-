version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash

env:
  variables:
    APP_NAME: "django-app"
    PYTHON_VERSION: "3.10"

steps:
  - type: Command
    name: "Install dependencies"
    command: |
      echo "[Start] Install dependencies"
      yum install -y epel-release
      yum install -y \
        python3 python3-pip python3-devel gcc \
        mysql-devel mysql-community-devel \
        pkgconfig libffi-devel openssl-devel make

      if ! command -v mysql_config &> /dev/null; then
        echo "[Error] mysql_config not found. Check if mysql-community-devel is properly installed."
        exit 1
      fi

      pip3 install django mysqlclient python-dotenv gunicorn || {
        echo "[Error] pip install failed"
        exit 1
      }

      echo "[Success] Install dependencies"

  - type: Command
    name: "Run tests"
    command: |
      cd web_app
      python3 manage.py test

  - type: Command
    name: "Collect static files"
    command: |
      cd web_app
      python3 manage.py collectstatic --noinput

  - type: Command
    name: "Create deployment package"
    command: |
      mkdir -p ${OCI_WORKSPACE_DIR}/deployment
      cp -r web_app ${OCI_WORKSPACE_DIR}/deployment/
      cd ${OCI_WORKSPACE_DIR}/deployment
      tar -czvf django-app.tar.gz web_app

outputArtifacts:
  - name: django-app-artifact
    type: BINARY
    location: ${OCI_WORKSPACE_DIR}/deployment/django-app.tar.gz
